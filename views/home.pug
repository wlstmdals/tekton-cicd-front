doctype html
html
    head
        meta(charset='utf-8')
        title ğŸŒŠì†Œë¦¬ë°”ë‹¤_4.1ğŸŒŠ
        meta(name='viewport', content='width=device-width, initial-scale=1')
        link(rel='stylesheet', href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css', integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T', crossorigin='anonymous')
        link(rel='stylesheet', href='css/style.css')
        link(rel='stylesheet', href='https://fonts.googleapis.com/css?family=Consolas')
    body
        .header
            .container
                h1 
                    a(href='/') ğŸŒŠMusic Wave
                    .d-flex.align-items-center
                        a(href='https://www.instagram.com/sush1_boy/' target='_blank').text-muted.mx-2 Desigined by Sushijin
                        .theme-switch
                            label(for='dark-mode-toggle').text-light.mx-2 Mode
                            input#dark-mode-toggle(type='checkbox')
                include new.pug
        .container.posts.mt-0#list-container
            include list.pug

        footer.fixed-bottom
            p.text-left.text-muted.footer-text Designed by Sushijin / Copyright.2024.AWS7th 'Team_Music Wave (3.1 / 4.1)'

script.
    function playSong(mp3Url, title, artist, imageUrl, tracknum) {
        console.log(`Playing song: Track ${tracknum}`);
        const player = document.getElementById('player');
        const source = player.querySelector('source');

        source.src = mp3Url;
        player.load();

        // ê³¡ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('now-playing-title').textContent = title;
        document.getElementById('now-playing-artist').textContent = artist;

        const nowPlaying = document.querySelector('.now-playing');
        nowPlaying.style.backgroundImage = `url('${imageUrl}')`;
        nowPlaying.style.backgroundSize = 'cover';
        nowPlaying.style.backgroundPosition = 'center';

        // í˜„ì¬ ë…¸ë˜ ì •ë³´ì™€ ì¬ìƒ ìœ„ì¹˜ ì €ì¥
        const songData = { mp3Url, title, artist, imageUrl, tracknum, currentTime: 0 };
        localStorage.setItem('currentSong', JSON.stringify(songData));

        // ê¸°ì¡´ ì¬ìƒ ìœ„ì¹˜ ë³µì›
        const savedSong = JSON.parse(localStorage.getItem('currentSong'));
        if (savedSong && savedSong.mp3Url === mp3Url) {
            player.currentTime = parseFloat(savedSong.currentTime || 0);
            console.log(`Resuming from ${savedSong.currentTime || 0} seconds`);
        }

        // canplay ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ìë™ ì¬ìƒ
        player.addEventListener('canplay', function handlePlay() {
            try {
                player.play();
                console.log('Playback started.');
            } catch (error) {
                console.error('Playback blocked by browser policy:', error.message);
            }
            player.removeEventListener('canplay', handlePlay); // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const toggle = document.getElementById('dark-mode-toggle');
        const body = document.body;

        // ì €ì¥ëœ ëª¨ë“œ ìƒíƒœ í™•ì¸ í›„ ì ìš©
        const currentMode = localStorage.getItem('darkMode');
        if (currentMode === 'dark') {
            body.classList.add('dark-mode');
            toggle.checked = true;
        }

        toggle.addEventListener('change', () => {
            if (toggle.checked) {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'dark');
            } else {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'light');
            }
        });

        // í˜„ì¬ ë…¸ë˜ ì •ë³´ ë³µì›
        const currentSong = JSON.parse(localStorage.getItem('currentSong'));
        if (currentSong) {
            // í…ìŠ¤íŠ¸ ì •ë³´ ë³µì›
            document.getElementById('now-playing-title').textContent = currentSong.title || 'No Title';
            document.getElementById('now-playing-artist').textContent = currentSong.artist || 'No Artist';

            // ë°°ê²½ ì´ë¯¸ì§€ ë³µì›
            const nowPlaying = document.querySelector('.now-playing');
            nowPlaying.style.backgroundImage = `url('${currentSong.imageUrl}')`;
            nowPlaying.style.backgroundSize = 'cover';
            nowPlaying.style.backgroundPosition = 'center';

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ë³µì›
            const player = document.getElementById('player');
            const source = player.querySelector('source');
            source.src = currentSong.mp3Url || '';
            player.load();

            // ì¬ìƒ ì‹œê°„ ë³µì›
            player.currentTime = parseFloat(currentSong.currentTime || 0);

            // canplay ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ìë™ ì¬ìƒ
            player.addEventListener('canplay', function handlePlay() {
                try {
                    player.play();
                    console.log('Playback resumed automatically.');
                } catch (error) {
                    console.error('Playback blocked by browser policy:', error.message);
                }
                player.removeEventListener('canplay', handlePlay); // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            });
        }
    });

    // F5 ë˜ëŠ” Ctrl+Rë¡œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ë° list-container ê°±ì‹ 
    document.addEventListener('keydown', async (event) => {
        if (event.key === 'F5' || (event.ctrlKey && event.key === 'r')) {
            event.preventDefault();
            try {
                console.log('Refreshing list-container...');
                const response = await fetch('/refresh-list');
                if (response.ok) {
                    const html = await response.text();
                    document.getElementById('list-container').innerHTML = html;
                    console.log('List-container refreshed.');
                } else {
                    console.error('Failed to fetch list:', response.statusText);
                    window.location.reload(); // ì‹¤íŒ¨ ì‹œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.error('Error refreshing list:', error.message);
                window.location.reload(); // ì‹¤íŒ¨ ì‹œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
            }
        }
    });

    // list-containerë¥¼ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
    async function fetchListContainer() {
        try {
            const response = await fetch('/refresh-list');
            if (response.ok) {
                const html = await response.text();
                const listContainer = document.getElementById('list-container');
                listContainer.innerHTML = html; // list-containerë§Œ ê°±ì‹ 
            } else {
                console.error('Failed to fetch list:', response.statusText);
            }
        } catch (error) {
            console.error('Error refreshing list:', error.message);
        }
    }

    window.addEventListener('beforeunload', () => {
        const player = document.getElementById('player');
        if (player) {
            const currentSong = JSON.parse(localStorage.getItem('currentSong'));
            if (currentSong) {
                currentSong.currentTime = player.currentTime; // í˜„ì¬ ê³¡ì˜ ì¬ìƒ ì‹œê°„ ì €ì¥
                localStorage.setItem('currentSong', JSON.stringify(currentSong));
            }
        }
    });
